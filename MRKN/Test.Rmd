---
title: "Climate Trend Analysis"
author: "Abigail Sanford, Julia Bickford, Andrea Cornelius"
date: "4/14/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


### Reading in data

```{r readdata}
library(lubridate)
library(tidyverse)
library(Kendall)

climtrend = read.table("thermal_precip_temp.csv",fill=TRUE,sep=',',header=T)
head(climtrend) # read in the data
```


```{r asdate}
climtrendtidy <- climtrend %>% 
  select(DATE, PRCP, TMAX, TMIN) %>% # selected the columns I want to keep which include date, precipitation, temperature max, and temperature minimum
  mutate(DATE = mdy(DATE)) %>% # converts the date column into the 'date' class
  mutate(YEAR = year(DATE)) # Create new column with just the year in it
```


### Running basic quality checks
Make a plot to see what data is missing.

Daily data of air temperature 
```{r dailyplots, echo=TRUE}

ggplot(climtrendtidy, aes(DATE, TMAX)) + 
  geom_line() + 
  labs(y="Daily Maximum Temperature (degrees F)", 
       x="Date")

ggplot(climtrendtidy, aes(DATE, TMIN)) + 
  geom_line() +
  labs(y="Daily Minimum Temperature (degrees F)",
       x="Date")

ggplot(climtrendtidy, aes(DATE, PRCP)) + 
  geom_line() +
  labs(y="Daily Rainfall (in)",
       x="Date")

```

we need to check this: "Some values are "NA" in temperature and precipitation; these have been trimmed automatically by ggplot, but this may not be the case for all functions. In general, you'll want to check meta data to see how missing data is labelled: -999 or NA are common choices." Ours is done as NA

### Filling in missing data

Generally speaking, if not much (say, < 0.5 percent) of your data is missing, then it's not going to cause substantial problems to fill in those gaps by making reasonable approximations. *BUT, you must remember that you are doing this!!!* Otherwise, you run the risk of drawing false conclusions by over-counting data that's not "real".

Some good rules of thumb for filling in missing data:

* **Temperature**
Replace missing data with the average of the previous and following day

* **Precip**
For dry places like the Sierra, assume no rain where data is missing (This may not be a good assumption in other places! be careful.)

Some demonstrations of how to do this in R are shown in the code block below:


```{r dailyplots.filled, echo=TRUE}

# find the row with missing data
fillrow = which(is.na(climtrendtidy$PRCP))
# display the rows to see how many there are
fillrow

# fill in data in the missing rows with zeros
climtrendtidy$PRCP[fillrow]=0
# replot to make sure it works
ggplot(climtrendtidy, aes(DATE, PRCP))+geom_line()+ labs(y="Daily rainfall (inch)", x="Date")


# find rows with missing data
# temperature: values are either NA or not reasonable for that location (here, below 40F)
fillrow = which(is.na(climtrendtidy$TMAX) | climtrendtidy$TMAX < 40)
fillrow = fillrow[2:length(fillrow)]
climtrendtidy$TMAX[fillrow]=(climtrendtidy$TMAX[fillrow+1]+climtrendtidy$TMAX[fillrow-1])/2
ggplot(climtrendtidy, aes(DATE, climtrendtidy$TMAX))+geom_line()+ labs(y="Daily Maximum Temperature (degrees F)", x="Date")

```


### Determining whether there is a trend

```{r annual, echo=TRUE}

climyearmean <- climtrendtidy %>%
  group_by(YEAR) %>%
  summarize(tmax= mean(TMAX), 
            tmin= mean(TMIN),
            precip= sum(PRCP))

climyearmean

ggplot(climyearmean, aes(x=YEAR, tmax)) + 
  geom_point(col="red") + 
  scale_y_continuous(limits=c(min(climyearmean$tmin),
                              max(climyearmean$tmax))) + 
  geom_point(data=climyearmean, aes(x=YEAR, tmin), col="blue")

a = ggplot(climyearmean, aes(x=YEAR, tmax)) + 
  geom_point(col="red") +
  stat_smooth(method="lm", col="red") +
  scale_y_continuous(limits=c(min(climyearmean$tmin),
                              max(climyearmean$tmax))) + 
  geom_point(data=climyearmean, aes(x=YEAR, tmin), col="blue")

```

Notice the different behavior of the min and max temperatures! 

OK now let's put a trend line on this thing.

```{r wy, echo=TRUE}

# now lets add a trend line

a + geom_point(data=climyearmean, aes(x=YEAR, tmin), col="blue") + 
  stat_smooth(data=climyearmean, aes(x=YEAR, tmin), col="blue", method="lm")


```



Now let's calculate the slope (or how quickly temperatures are rising; we do this with linear regression)

```{r regressionline, echo=TRUE}


res=lm(tmin~dt, data=clim.mwy)
summary(res)
confint(res,"dt", level=0.95)
ggplot(clim.mwy, aes(x=dt, y=tmin)) + stat_summary(fun.y="mean", geom="point", col="red", size=4)+theme(axis.text=element_text(size=14, face="bold"), axis.title=element_text(size=14, face="bold")) + geom_smooth(method="lm")
```

The slope on a linear regression between Tmin and wy is the rate of increase in Tmin (mean annual daily minimum temperature).

The value of the slope is -0.015 F/year, and is not statistically significant.


Let's do the same analysis for the MAXIMUM temperature now...

```{r tmaxreg, echo=TRUE}


res=lm(tmax~dt, data=clim.mwy)
summary(res)
confint(res,"dt", level=0.95)
ggplot(clim.mwy, aes(x=dt, y=tmax)) + stat_summary(fun.y="mean", geom="point", col="red", size=4)+theme(axis.text=element_text(size=14, face="bold"), axis.title=element_text(size=14, face="bold")) + geom_smooth(method="lm")
```

Now we find a positive trend: 0.071F/year, or 0.71F/decade. But notice that there seem to be some outliers toward the end of the record...

We might also cut the data into specific periods and see how the slope is changing as a function of time.

```{r subset, echo=TRUE}


# early portion
res_early=lm(tmin~dt, data=subset(clim.mwy, clim.mwy$dt %in% c(1998:2008)))
summary(res_early)
confint(res_early,"dt", level=0.90)
ggplot(subset(clim.mwy, clim.mwy$dt %in% c(2008:2018)), aes(x=dt, y=tmin)) + stat_summary(fun.y="mean", geom="point", col="red", size=4)+theme(axis.text=element_text(size=14, face="bold"), axis.title=element_text(size=14, face="bold")) + geom_smooth(method="lm")

# last decade
res_late=lm(tmin~dt, data=subset(clim.mwy, clim.mwy$dt %in% c(1998:2022)))
summary(res_late)
confint(res_late,"dt", level=0.90)
ggplot(subset(clim.mwy, clim.mwy$dt %in% c(1998:2022)), aes(x=dt, y=tmin)) + stat_summary(fun.y="mean", geom="point", col="red", size=4)+theme(axis.text=element_text(size=14, face="bold"), axis.title=element_text(size=14, face="bold")) + geom_smooth(method="lm")


```


### Non-parametric trend test: Mann-Kendall

Regression assumes a linear relationship - and normally distributed data - sometimes that isn't true, we can use non-parameteric tests to look for trends. In these cases, the Mann-Kendall test is commonly used.

tau ranges from -1 to 1 and denotes the "strength" of the trend; p-value denotes significance. Strength however can not be interpreted as slope!

```{r kendall, echo=TRUE}


MannKendall(clim.mwy$tmin)
MannKendall(clim.mwy$tmax)
MannKendall(clim.mwy$precip)

```

### Test for differences between time periods

We might also look at difference in means (or variance) between the two periods ...Using

T-test (if we think the data is normally distributed)
or Rank-Sum if we do not.


```{r ttest, echo=TRUE}

t.test(subset(clim.mwy$tmin, clim.mwy$dt %in% 1953:1969), subset(clim.mwy$tmin, clim.mwy$dt %in% 1995:2004))

wilcox.test(subset(clim.mwy$tmin, clim.mwy$dt %in% 1953:1969), subset(clim.mwy$tmin, clim.mwy$dt %in% 1995:2004))

```
There is a statistically significant difference in the means according to both tests, although the p value is slightly lower for the T test.


### Aggregation: seasonal!

An alternative approach to aggregation (mean by year)
is to look at a particular season, lets say we want to look only at summer (July and August)


```{r alternative, echo=TRUE}
# create a variable
clim$season = ifelse(month(date) %in% c(12,1,2), 1, ifelse(month(date) %in% c(3:5),2, ifelse(month(date) %in% c(6:8),3,4)))
clim.byseason = clim %>% group_by(year(date),season) %>% summarize(tmax=mean(TMAX), tmin=mean(TMIN), precip=sum(PRCP))

# look only at summer
clim.summer = subset(clim.byseason, clim.byseason$season==3)
tmp=unique(year(date))
clim.summer$wy = tmp[1:length(tmp)-1]

ggplot(clim.summer, aes(x=wy, y=tmin)) + stat_summary(fun.y="mean", geom="point", col="red", size=4)+theme(axis.text=element_text(size=14, face="bold"), axis.title=element_text(size=14, face="bold")) + geom_smooth(method="lm")+labs(y=" Summer Minimum Daily Temperature C")

res=lm(tmax~wy, data=clim.summer)
summary(res)
confint(res,"wy", level=0.95)

```
Notice how the trends in summer minimum temperature differ from the annual minimum temperature trend!





